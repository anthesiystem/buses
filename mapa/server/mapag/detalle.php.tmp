<?php
require_once __DIR__ . '/../config.php';

// Función de escape HTML
function h($s) { 
    return htmlspecialchars((string)$s, ENT_QUOTES, 'UTF-8'); 
}

// Asegurar la cabecera de respuesta correcta
header('Content-Type: text/html; charset=utf-8');

// Validación del parámetro estado
if (!isset($_GET['estado']) || empty(trim($_GET['estado']))) {
    header('HTTP/1.1 400 Bad Request');
    die('El parámetro "estado" es requerido');
}

$estado = trim($_GET['estado']);

// Asegurar que la conexión está en UTF-8
if ($pdo) {
    $pdo->exec("SET NAMES 'utf8mb4'");
}

// Consulta SQL
$sql = "SELECT 
    r.Fk_motor_base, r.Fk_dependencia, r.Fk_entidad,
    r.Fk_bus, r.Fk_estado_bus, r.Fk_categoria,
    r.Fk_tecnologia, r.Fk_etapa,
    r.fecha_inicio, r.fecha_migracion,
    b.descripcion  AS bus_nombre,
    eb.descripcion AS estado_nombre,
    t.numero_version AS version,
    t.descripcion   AS tecnologia,
    d.descripcion AS dependencia,
    e.descripcion AS entidad,
    c.descripcion AS categoria,
    en.descripcion AS motor_base_nombre,
    et.descripcion AS etapa,
    et.avance      AS avance
FROM registro r
INNER JOIN entidad     e  ON e.ID  = r.Fk_entidad
INNER JOIN estado_bus  eb ON eb.ID = r.Fk_estado_bus
LEFT  JOIN bus         b  ON b.ID  = r.Fk_bus AND b.activo = 1
LEFT  JOIN dependencia d  ON d.ID  = r.Fk_dependencia
INNER JOIN categoria   c  ON c.ID  = r.Fk_categoria
INNER JOIN motor_base  en ON en.ID = r.Fk_motor_base
INNER JOIN tecnologia  t  ON t.ID  = r.Fk_tecnologia
LEFT  JOIN etapa       et ON et.ID = r.Fk_etapa
WHERE UPPER(TRIM(e.descripcion)) = UPPER(TRIM(:estado))
AND r.activo = 1
ORDER BY FIELD(c.descripcion, 'Productivos','Centrales','Migraciones','Pruebas'),
         c.descripcion,
         b.descripcion";

try {
    $stmt = $pdo->prepare($sql);
    $stmt->bindParam(':estado', $estado, PDO::PARAM_STR);
    $stmt->execute();
    $rows = $stmt->fetchAll(PDO::FETCH_ASSOC);
} catch (PDOException $e) {
    error_log("Error en la consulta SQL: " . $e->getMessage());
    die('Error al obtener los datos del estado');
}

// Procesar los resultados
$registros = [];
$total = 0;

foreach ($rows as $row) {
    $cat = ucfirst(strtolower($row['categoria'] ?? 'Otro'));
    $registros[$cat][] = $row;
    $total++;
}

// Si no hay resultados, mostrar mensaje
if (empty($rows)) {
    die("<div class='alert alert-warning'>No se encontraron registros para el estado: " . h($estado) . "</div>");
}

// Mapeo de categorías y sus estilos
$catAccents = [
    'Productivos' => ['accent'=>'#22c55e','chipBg'=>'#d1fae5','chipFg'=>'#065f46'],
    'Centrales'   => ['accent'=>'#0ea5e9','chipBg'=>'#cff0ff','chipFg'=>'#075985'],
    'Migraciones' => ['accent'=>'#f59e0b','chipBg'=>'#fff1c2','chipFg'=>'#7c4a03'],
    'Pruebas'     => ['accent'=>'#ef4444','chipBg'=>'#ffe0e0','chipFg'=>'#7f1d1d'],
    'Otro'        => ['accent'=>'#6b7280','chipBg'=>'#eceff3','chipFg'=>'#374151']
];

// Función para determinar la clase de estatus
function estatusClass($tx) {
    $tx = strtoupper(trim($tx));
    if ($tx === 'IMPLEMENTADO')    return 'st-impl';
    if ($tx === 'PRUEBAS')        return 'st-prue';
    if ($tx === 'SIN IMPLEMENTAR') return 'st-sin';
    return 'st-otro';
}
?>
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detalle del Estado</title>
    <style>
        /* Estilos básicos */
        .resumen-top { 
            display: flex; 
            gap: 1rem; 
            align-items: center; 
            justify-content: space-between; 
        }
        .resumen-table {
            border-collapse: separate;
            border-spacing: 0;
            width: 100%;
            font-size: 0.92rem;
            border-radius: 0.75rem;
            overflow: hidden;
        }
        .resumen-table thead th {
            position: sticky;
            top: 0;
            z-index: 2;
            background: #ffcfcf;
            color: #fd0d59;
            font-weight: 700;
            padding: 0.7rem 0.65rem;
            text-align: center;
            white-space: nowrap;
        }
        .st-badge {
            display: inline-block;
            padding: 0.35rem 0.5rem;
            border-radius: 0.5rem;
            font-weight: 700;
            font-size: 0.82rem;
        }
        .st-impl { color: #0f5132; background: rgba(25,135,84,.14); }
        .st-prue { color: #664d03; background: rgba(255,193,7,.18); }
        .st-sin  { color: #495057; background: rgba(108,117,125,.15); }
        .st-otro { color: #1f2937; background: rgba(31,41,55,.12); }
        
        .progress-thin {
            height: 6px;
            border-radius: 999px;
            background: rgba(0,0,0,.08);
            overflow: hidden;
        }
        .progress-thin .bar {
            height: 100%;
            background: #e90e45;
        }
        .modal-content.detalles {
            border: 0;
            border-radius: 1rem;
            box-shadow: 0 20px 45px rgba(0,0,0,.15);
            overflow: hidden;
        }
        .detalles-table {
            width: 100%;
            font-size: 0.85rem;
        }
        .chip-cat {
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            padding: 0.25rem 0.6rem;
            border-radius: 999px;
            font-weight: 700;
            font-size: 0.85rem;
            background: var(--chip-bg, rgba(0,0,0,.06));
            color: var(--chip-fg, #333);
        }
    </style>
</head>
<body>
    <div class="resumen-top mb-2">
        <h3 class="m-0"><strong>TOTAL DE BUSES:</strong> <?= (int)$total ?></h3>
        <button class="btn btn-light btn-sm" data-bs-toggle="modal" data-bs-target="#modalDetalles">VER DETALLES</button>
    </div>

    <div class="table-responsive mt-3">
        <table class="resumen-table">
            <thead>
                <tr>
                    <th>Categoría</th>
                    <th>Bus</th>
                    <th>Versión</th>
                    <th>Estatus</th>
                    <th style="min-width:140px">Avance</th>
                </tr>
            </thead>
            <tbody>
                <?php 
                $orden = ['Productivos', 'Centrales', 'Migraciones', 'Pruebas'];
                
                // Primero las categorías en orden preferido
                foreach ($orden as $cat):
                    if (!isset($registros[$cat])) continue;
                    foreach ($registros[$cat] as $row):
                        $sty = $catAccents[$cat] ?? $catAccents['Otro'];
                        $ver = trim((string)($row['version'] ?? ''));
                        $por = max(0, min(100, (int)($row['avance'] ?? 0)));
                        $stc = estatusClass($row['estado_nombre'] ?? '');
                ?>
                <tr class="row-accent" style="--row-accent: <?= $sty['accent'] ?>">
                    <td>
                        <span class="chip-cat" style="--chip-bg: <?= $sty['chipBg'] ?>; --chip-fg: <?= $sty['chipFg'] ?>">
                            <?= h($cat) ?>
                        </span>
                    </td>
                    <td class="text-strong"><?= h($row['bus_nombre']) ?></td>
                    <td><span class="code-badge"><?= h($ver) ?></span></td>
                    <td><span class="st-badge <?= $stc ?>"><?= h($row['estado_nombre']) ?></span></td>
                    <td>
                        <div class="progress-thin mb-1">
                            <div class="bar" style="width: <?= $por ?>%"></div>
                        </div>
                        <small class="text-body-secondary fw-bold"><?= $por ?>%</small>
                    </td>
                </tr>
                <?php 
                    endforeach;
                endforeach;
                
                // Luego el resto de categorías
                foreach ($registros as $cat => $filas):
                    if (in_array($cat, $orden, true)) continue;
                    foreach ($filas as $row):
                        $sty = $catAccents['Otro'];
                        $ver = trim((string)($row['version'] ?? ''));
                        $por = max(0, min(100, (int)($row['avance'] ?? 0)));
                        $stc = estatusClass($row['estado_nombre'] ?? '');
                ?>
                <tr class="row-accent" style="--row-accent: <?= $sty['accent'] ?>">
                    <td>
                        <span class="chip-cat" style="--chip-bg: <?= $sty['chipBg'] ?>; --chip-fg: <?= $sty['chipFg'] ?>">
                            <?= h($cat) ?>
                        </span>
                    </td>
                    <td class="text-strong"><?= h($row['bus_nombre']) ?></td>
                    <td><span class="code-badge"><?= h($ver) ?></span></td>
                    <td><span class="st-badge <?= $stc ?>"><?= h($row['estado_nombre']) ?></span></td>
                    <td>
                        <div class="progress-thin mb-1">
                            <div class="bar" style="width: <?= $por ?>%"></div>
                        </div>
                        <small class="text-body-secondary fw-bold"><?= $por ?>%</small>
                    </td>
                </tr>
                <?php 
                    endforeach;
                endforeach;
                ?>
            </tbody>
        </table>
    </div>
</body>
</html>
